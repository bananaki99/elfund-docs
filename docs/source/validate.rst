Επικύρωση Αρχειων DBDAT και IFDAT
=================================

Για κάθε υποβαλλόμενο αρχείο δημιουργείται ένα αρχείο επικύρωσης ΑΠΑ το οποίο
θα λαμβάνει ο χρήστης του υποβαλλόμενο αρχείου και η δομή του περιγράφεται στην
ενότητα :doc:`validation`.

Η ονομασία του αρχείου επικύρωσης ακολουθεί τον ακόλουθο μορφότυπο
``ACK_{ID}_{PARTNER}_{USER}.json`` όπου: 

* ID είναι ένας μοναδικός ακέραιος αριθμός ίδιος με τον αριθμό του εισερχόμενου αρχείου.

* USER είναι ο αναγνωριστικός κωδικός του χρήστη.  

* PARTNER είναι ο αναγνωριστικός κωδικός της ΜΠΣ.  

Για παράδειγμα ένα αρχείο επικύρωσης προς τον χρήστη χρήστη **aloumiotis** με
ID 5 που υπέβαλλε στοιχεία για τη ΜΠΣ με κωδικό EGR010 λαμβάνει την ονομασία
``ACK_0000000005_EGR010_aloumiotis_.json``.


Επικύρωση αρχείων
-----------------

1.  Κάθε χρήστης πρέπει να έχει το δικαίωμα να ανεβάσει στοιχεία για κάποια
    δομή δεδομένων. 

#.  Με βάση το username και τη ΜΠΣ δημιουργείται το όνομα του αρχείου επικύρωσης ΑΠΑ.

#.  Σε περίπτωση που βρεθεί ένα από τα παρακάτω λάθη το υποβαλλόμενο αρχείο απορρίπτεται,
    καταγράφεται το λάθος στο ΑΠΑ και στο HEADER του ΑΠΑ συμπληρώνεται η
    ένδειξη uploaded=False και οι επόμενοι έλεγχοι δεν πραγματοποιούνται στο αρχείο.

#.  Αν η επέκταση του αρχείου (extension/suffix) δεν είναι .xlsx ή .json το αρχείο απορρίπτεται. 

#.  Εάν το αρχείο είναι μορφής xlsx ελέγχονται τα παρακάτω:

    * Εάν δεν υπάρχει το φύλλο HEADER τότε το αρχείο απορρίπτεται με no_header
      λάθος.

    * Εάν εμφανιστεί κάποιο άλλο λάθος στην επεξεργασία του φύλλου HEADER τότε
      το αρχείο απορρίπτεται με corrupt_excel τύπου header λάθος.

    * Σε περίπτωση που στα CONTENTS εμφανίζεται ότι κάποιο φύλλο περιέχει
      στοιχεία αλλά στο αντίστοιχο φύλλο το κελί Α4 είναι κενό, τότε
      το αρχείο απορρίπτεται με no_content λάθος.  Προσοχή η επεξεργασία κάθε
      φύλλου σταματάει όταν εντοπιστεί το πρώτο κενό κελί της στήλης Α. 


#.  Εάν το αρχείο είναι μορφής json ελέγχονται τα παρακάτω:

    * Σε περίπτωση που δεν μπορεί να διαβαστεί ως αρχείο json τότε το αρχείο απορρίπτεται με λάθος corrupt_json.

    * Εάν δεν υπάρχει το κλειδί HEADER τότε το αρχείο απορρίπτεται με no_header λάθος.

#.  Σε περίπτωση που το USERNAME ή το PARTNER από τα περιεχόμενα του αρχείου είναι
    διαφορετικό σε σχέση με αυτά της ονομασίας του αρχείου τότε το αρχείο απορρίπτεται με inconsistency λάθος.


#.  Σε περίπτωση που το αρχείο είναι xlsx μετατρέπεται σε μορφή json.  Δηλαδή
    για κάθε καταχώρηση στο φύλλο CONTENTS διαβάζεται το αντίστοιχο φύλλο και
    μετατρέπεται σε μορφή json με βάση το json schema της δομής.  Σε περίπτωση
    λάθους στη μετατροπή εισάγεται conversion λάθος.

#.  Το json αρχείο ελέγχεται σύμφωνα με το JSON schema της δομής και στην περίπτωση που
    εντοπιστούν λάθη το αρχείο απορρίπτεται συμπληρώνοντας τα schema_errors.

#.  Κάθε εγγραφή για κάθε πίνακα ελέγχεται εάν ο χρήστης έχει την εξουσιοδότηση
    να την υποβάλλει. Οι χρήστες DBDAT έχουν την εξουσιοδότηση να υποβάλλουν
    οποιαδήποτε εγγραφή ενώ οι χρήστες IFDAT έχουν την εξουσιοδότηση να
    υποβάλλουν μόνο τις εγγραφές που περιγράφονται στην ενότητα
    :doc:`authorization`.  Σε περίπτωση που εντοπιστούν μη εξουσιοδοτημένες
    εγγραφές το αρχείο απορρίπτεται και συμπληρώνονται οι μη εξουσιοδοτημένες
    εγγραφές στο ΑΠΑ.

#.  Κάθε ΕΟ μπορεί να έχει έως μία ΜΠΣ ανά χρονικό διάστημα.  Αν μια υποβολή
    ορίζει πάνω από μία απορρίπτεται το αρχείο και συμπληρώνεται το dup_ra
    λάθος.

#.  Για τα αρχεία που δεν έχουν υπάρξει κρίσιμα λάθη μέχρι αυτό το σημείο τα
    περιεχόμενα τους εισάγονται στη βάση DAT και ο χρήστης λαμβάνει το ΑΠΑ με
    τα αποτελέσματα της επικύρωσης.  Σε αυτό το στάδιο ελέγχεται επίσης και αν
    ένας νέος alias κωδικός αναγνωρίζει πάνω από μία οντότητα.  Αν ναι
    απορρίπτεται η εγγραφή και όχι το αρχείο και εμφανίζονται οι διπλοεγγραφές
    στα warnings του AΠA.
